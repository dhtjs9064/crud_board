<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- ì¸í„°íŽ˜ì´ìŠ¤ ê²½ë¡œ -->
<mapper namespace="com.study.connection.repository.BoardRepository">
    <!-- TODO: í™”ë©´ì„ ë³´ì—¬ì£¼ê¸°ì „ ë°ì´í„°ë§Œ ìž‘ì„±-->
    <!-- TODO: db.sqlë§Œë“¤ê¸°-->
    <!-- ëª©ë¡ ì¡°íšŒ -->
    <select id="getList" resultType="com.study.connection.dto.BoardListItemResponse">
        <!-- ðŸš¨ðŸš¨ í•„ë“œ ë§¤í•‘ ë¶ˆì¼ì¹˜ í•´ê²°: AS (ë³„ì¹­) ì‚¬ìš© ðŸš¨ðŸš¨ -->
        SELECT
        board_id AS boardId,
        category AS boardCategory,
        title AS boardTitle,
        writer AS boardWriter,
        views AS boardViews,
        created_at AS boardCreatedAt,
        updated_at AS boardUpdatedAt
        <!-- DTOì— ì—†ëŠ” contentì™€ availableì€ ëª©ë¡ ì¡°íšŒì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤. -->
        FROM board
        <where>
            available = 1
            <!-- ðŸš¨ðŸš¨ ìˆ˜ì •: DTO í•„ë“œëª…ì— ë§žê²Œ category -> boardCategoryë¡œ ë³€ê²½ ðŸš¨ðŸš¨ -->
            <if test="boardCategory != null and boardCategory != '' and boardCategory != 'ì „ì²´'">
                AND category = #{boardCategory}
            </if>
            <!-- ðŸš¨ðŸš¨ ìˆ˜ì •: DTO í•„ë“œëª…ì— ë§žê²Œ keyword -> searchKeywordë¡œ ë³€ê²½ ðŸš¨ðŸš¨ -->
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                title LIKE CONCAT('%', #{searchKeyword}, '%')
                OR writer LIKE CONCAT('%', #{searchKeyword}, '%')
                OR content LIKE CONCAT('%', #{searchKeyword}, '%')  )
            </if>
        </where>
        <!-- ðŸš¨ðŸš¨ ìˆ˜ì •: DB ì»¬ëŸ¼ëª…ì— ë§žê²Œ boardID -> board_idë¡œ ë³€ê²½ ðŸš¨ðŸš¨ -->
        ORDER BY board_id DESC
        <!-- serviceì˜ db -->
        LIMIT #{limit}
        OFFSET #{skipPage}
    </select>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) FROM board
        <where>
            available = 1
            <if test="boardCategory != null and boardCategory != '' and boardCategory != 'ì „ì²´'">
                AND category = #{boardCategory}
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                title LIKE CONCAT('%', #{searchKeyword}, '%')
                OR writer LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>
        </where>
    </select>


    <!-- ê²Œì‹œê¸€ ë“±ë¡ -->
    <insert id="write" parameterType="BoardDTO" useGeneratedKeys="true" keyProperty="boardID">
        INSERT INTO board (category, title, writer, password, content, available)
        VALUES (#{category}, #{title}, #{writer}, #{password}, #{content}, #{available})
    </insert>

    <!-- ê²Œì‹œê¸€ ë³´ê¸° -->
    <select id="getBoard" resultType="BoardDTO">
        SELECT * FROM board WHERE board_id = #{boardID}
    </select>

    <!-- ê²Œì‹œê¸€ ìˆ˜ì • -->
    <update id="modify">
        UPDATE board
        SET
            writer = #{writer},
            password = #{password},
            title = #{title},
            content = #{content},
            updated_at = NOW()
        WHERE board_id = #{boardId} AND password = #{password}
    </update>

    <!-- ê²Œì‹œê¸€ ì‚­ì œ (ì•ˆë³´ì´ê²Œ) -->
    <update id="delete">
        UPDATE board
        SET available = 0
        WHERE board_id = #{boardID}
    </update>
</mapper>
